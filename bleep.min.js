window.Bleep=(function(){function a(){}function l(){}l.prototype=new Array();a.version="0.0.1";a.liveEvents;a.pendingEvents=new l();function m(){this.noteLength}function e(p){this.noteLength=p;this.volume=0;this.o;this.g}function f(p,q){this.HzNote=p;this.noteLength=q;this.volume=1;this.o;this.g}function c(p,q){this.settingName=p;this.settingVal=q}e.prototype=new m();f.prototype=new m();c.prototype=new m();e.prototype.constructor=e;f.prototype.constructor=f;c.prototype.constructor=c;var b=a.settings={bpm:90,defaultNoteLength:16,waveform:"sine",masterVolume:1};AC=new window.AudioContext;MASTER_GAIN=AC.createGain();MASTER_GAIN.connect(AC.destination);MASTER_GAIN.gain.value=b.masterVolume;var g=false;a.tone=function(r,t,q){if(typeof t==="undefined"){t=b.defaultNoteLength}if(r.charAt(0)==="R"){a.rest(r);return}var p=stringToHzNote(r,q);var s=new f(p,t);a.pendingEvents.push(s);console.log("Pushed note to queue: "+r);console.log(s)};a.rest=function(p){restNoteLength=restArgToDuration(p);var q=new e(restNoteLength);a.pendingEvents.push(q);console.log("Pushed rest to queue: "+p);console.log(q)};function j(p){if(p===null){return}else{if(g===true){setTimeout(function(){j(p)},10)}else{h(p)}}}function h(q){q.g.gain.value=q.volume;if(g===true){throw"sync error"}g=true;setTimeout(function(){q.g.gain.value=0;g=false},q.duration-10);console.log("handling event:");console.log(q);if(a.liveEvents.length===0){return}var p=i();setTimeout(function(){console.log("calling handleEvent on ");console.log(p);j(p)},q.duration)}function i(){if(a.liveEvents.length===0){return null}var p=a.liveEvents.shift();if(p.constructor.name==="SettingEvent"){b[p.settingName]=p.settingVal;console.log("made setting "+p.settingName+" : "+b[p.settingName]);return i()}p.g=AC.createGain();p.g.connect(MASTER_GAIN);p.g.gain.value=0;p.o=AC.createOscillator();p.o.type=b.waveform;p.o.frequency.value=parseFloat(p.HzNote);p.o.connect(p.g);p.o.start(0);p.duration=noteLengthToMs(p.noteLength);p.volume=setVolumeForWaveformType(p.o,p);return p}a.stop=function(){a.liveEvents=new l()};a.start=function(){if(g===true){a.stop();setTimeout(function(){a.start()},20)}else{a.liveEvents=a.pendingEvents;a.pendingEvents=new l();var p=i();if(p===null){return false}else{j(p)}}};noteLengthToMs=function(p){return((60000)/(b.bpm*(p/4)))};setVolumeForWaveformType=function(q,p){switch(q.type){case"sine":return p.volume*1;break;case"square":return p.volume*0.3;break;case"sawtooth":return p.volume*0.4;break;case"triangle":return p.volume*0.8;break}};restArgToDuration=function(p){if(typeof p==="undefined"){return b.defaultNoteLength}else{if(typeof p==="number"){return Number(p)}else{if(p.charAt(0)==="R"){if(p.length===3){return p.substring(1,3)}else{return Number(p.charAt(1))}}else{throw"Invalid rest parameter: "+p}}}};a.setbpm=function(q){var p=new c("bpm",q);a.pendingEvents.push(p);console.log("Pushed bpm event to queue:");console.log(p)};a.setWaveform=function(p){var q=new c("waveform",p);a.pendingEvents.push(q);console.log("Pushed waveform event to queue:");console.log(q)};a.setMasterVolume=function(p){var q=new c("masterVolume",parseFloat(p));a.pendingEvents.push(q);console.log("Pushed masterVolume event to queue:");console.log(q)};a.liveSetMasterVolume=function(p){p=parseFloat(p);b.masterVolume=p;MASTER_GAIN.gain.value=p};a.bloop=function(v){var u,t,s,r,q;v=n(v);a.setbpm(v.bpm);u=getScale(v.scaleType,v.rootNote);for(var p=0;p<v.notes;p++){if(p<v.notes-1){t=u[getRandomArbitrary(0,u.length)];r=v.octave+getRandomArbitrary(0,v.octaveRange);q=StepsToHzNote(halfStepsFromA(t,r))}else{q=StepsToHzNote(halfStepsFromA(v.rootNote,4))}s=new f(q,v.noteLength);a.pendingEvents.push(s)}};function n(p){var q={rootNote:getRandomArbitrary(0,12),notes:6,scaleType:"minor",noteLength:32,bpm:b.bpm,octaveRange:1,octave:4};return o(p,q)}a.arp=function(w){var u,t,r,q,s,v;w=k(w);a.setbpm(w.bpm);w.scale=getScale(w.scaleType,w.rootNote);r=w.octave;v=w.scale;if(w.direction==="up"){s=1;lastNoteInOctave=0}else{s=-1;lastNoteInOctave=v.length-1}for(var p=0;p<w.notes;p++){u=v[d(p,w)];if(u===v[lastNoteInOctave]){if(r-w.octave>(w.octaveRange-1)){console.log("resetting octave");r=w.octave}else{r+=s}}q=StepsToHzNote(halfStepsFromA(u,r));t=new f(q,w.noteLength);a.pendingEvents.push(t)}};function d(p,r){var q=r.scale.length;if(r.direction==="up"){return(p+1)%q}else{return(r.notes-p)%q}}function k(p){var q={rootNote:"A",notes:20,scaleType:"minor",noteLength:32,bpm:b.bpm,octaveRange:1,octave:4,direction:"up"};return o(p,q)}function o(r,s){if(typeof r==="undefined"){var r}for(var q in r){s[q]=r[q]}if(typeof s.rootNote==="string"){s.rootNote=stringToStepsFromA(s.rootNote)}return s}a.sequence=function(p){for(var r in p){var q=p[r];if(q.constructor.name==="Array"){a.tone(q[0],q[1],q[2])}else{a.tone(q)}}};return a}());